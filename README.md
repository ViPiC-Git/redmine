# Описание
`JScript` для взаимодействия с [Redmine](http://www.redmine.org/) по средствам `REST API` в `WSH` среде операционной системы **Windows**. В первую очередь скрипт предназначен для использования в планировщике задач. С помощью скрипта можно организовать синхронизацию пользователей с **Active Directory** через `LDAP` и автоматическое изменение (закрытие) задач. Для взаимодействия с **Redmine** используется `XML` формат.
# Использование
В командной строке **Windows** введите следующую команду:
```bat
cscript redmine.min.js <url> <key> <task> [... <param>]
```
- `<url>` - Базовый url адрес для запросов к **REST API**. Косая черта в конце не обязательна. Передача логина и пароля для **Basic Authentication** не поддерживается.
- `<key>` - Ключ доступа к **REST API** для взаимодействия. Как включить **REST API** и посмотреть ключ пользователя для взаимодействия описано в [официальной документации](http://www.redmine.org/projects/redmine/wiki/Rest_api).
- `<task>` - Имя задачи которую нужно выполнить.
- ... `<param>` - Параметры для задачи.
## Поддерживаемые задачи
`users.sync` - Синхронизация пользователей с **Active Directory** через **LDAP**. Задача обновляет данные у пользователей **Redmine**, блокируя отключённых пользователей и добавляя новых. Пользователи **Redmine**, у которых нет соответствующих пользователей в контейнере **Active Directory**, не трогаются. Соответствие проверяется по логину пользователя. Подключение к **Active Directory** идёт в контексте текущего пользователя, поэтому при запуске скрипта из планировщика задач не забудьте указать от имени какого пользователя запускать задачу.
```bat
cscript redmine.min.js <url> <key> users.sync <fields> [<container>] [<auth>] [<format>]
```
- `<fields>` - Соответствие **id** поля пользователя и **имени** атрибута **LDAP** в формате `id:name;id:name`. Для **настраиваемых полей** пользователей укажите идентификатор поля в виде числа.
- `<container>` - Контейнер в котором искать пользователей в **Active Directory**. Можно указать **GUID**, **name**, **distinguishedName**, **sAMAccountName** или **LDAP-SQL** запрос с шаблонизацией и переменными `{select}`, `{protocol}`, `{parent}`. В качестве **LDAP-SQL** запроса можно указать часть запроса начиная с `WHERE`.
- `<auth>` - Идентификатор режима аутентификации в приложении. Идентификаторы можно посмотреть на странице **Режимы аутентификации** *(Администрирование - Авторизация с помощью LDAP)* в **Redmine**.
- `<format>` - Идентификатор формата отображения имён. Идентификаторы можно посмотреть на странице **Настройки** *(Настройки - Отображение - Формат отображения имени)* в **Redmine**. По умолчанию используется `lastname_firstname`.

`issues.change` - Изменение задач. Задача изменяет данные в заданных полях. Поддерживается дополнительная фильтрация.
```bat
cscript redmine.min.js <url> <key> issues.change [<query>] <fields> [<filters>]
```
- `<query>` - Идентификатор сохранённого запроса для всех проектов. Запросы можно добавить на странице **Задачи** в **Redmine**. Запросы выводятся в правом блоке с заголовками **Сохранённые запросы** и **Мои сохранённые запросы**. Запрос должен быть виден из-под пользователя ключ доступа которого используется для взаимодействия с **REST API**. В настройках запроса обязательно должна стоять галочка **Для всех проектов**.
- `<fields>` - Поля и их значения в формате `id:value;id:value` с поддержкой шаблонизации. Если в значении есть пробельные символы, то это значение нужно заключить в двойные кавычки. Для **настраиваемых полей** задачи укажите идентификатор поля в виде числа.
- `<filters>` - Дополнительный фильтр для задач в формате `id:value;id:value` с поддержкой шаблонизации. Если в значении есть пробельные символы, то это значение нужно заключить в двойные кавычки.
## Шаблонизация
В **параметрах** и **значениях** которые поддерживают шаблонизацию, можно указывать шаблоны. **Шаблон** из себя представляет строку которая может содержать *(а может и не содержать)* один или несколько разделителей `|`. **Разделитель** делит строку на фрагменты. В **фрагменте** текста может содержаться *(а может и не содержаться)* один или несколько указателей на значение. **Указатель** на значение `{object.key.id}` представляет из себя последовательность ключей по которым нужно пройти в объекте чтобы получить значение. Если **значение** отсутствует, то **фрагмент** удаляется *(для удаления фрагмента значение должно именно отсутствовать, а не быть пустым)*. В качестве **объекта** используется сущность с которой работает задача. Если нужно оставить значение разделителя, то поставьте разделитель несколько раз подряд.
```
"Текст для примера|| {author.name} проекта № {project.id}| {done} %|."
```
# Примеры использования
Синхронизировать пользователей из контейнере **Active Directory** с **GUID** `{8F640E75-C072-47CA-5DBD-66AFC5D7E38F}` в приложение **Redmine** расположенное по адресу https://redmine.org используя **ключ доступа** пользователя `8dbfd7b0a9c9279a97fedfb82710aed96bcf53fc`. В **настраиваемое полей** с идентификатором **12** записать **руководителя** пользователя в формате `lastname_firstname`, а в **поле** с идентификатором **10** записать **Заметку** о пользователе. Указать **режим аутентификации** как **1**.
```bat
cscript redmine.min.js https://redmine.org 8dbfd7b0a9c9279a97fedfb82710aed96bcf53fc users.sync
login:sAMAccountName;firstname:givenName;lastname:sn;mail:mail;12:manager;10:info
{8F640E75-C072-47CA-5DBD-66AFC5D7E38F} 1 lastname_firstname
```
Изменить идентификатор **статуса** на **8**, процент **выполнения** на **10** и добавить **комментарий** с шаблонизацией для задач из **сохранённого запроса** с идентификатором **46**, если **описание** задачи содержит `заявка`, **настраиваемое поле** с идентификатором **10** содержит `серия`, это **не приватная** задача и задача назначена автору.
```bat
cscript redmine.min.js https://redmine.org 8dbfd7b0a9c9279a97fedfb82710aed96bcf53fc issues.change
46 status:8;done:10;notes:"{author.name}, ваша заявка автоматически зарегистрирована в системе."
description:заявка;10:серия;private:true;assigned.id:{author.id}
```