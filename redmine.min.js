/* 0.1.0 взаимодействие с redmine по средствам api

cscript redmine.min.js <url> <key> <task> [... <param>]
cscript redmine.min.js <url> <key> users.sync <fields> [<container>] [<auth>] [<format>]
cscript redmine.min.js <url> <key> issues.change [<query>] <fields> [<filters>]

<url>				- базовый url адрес для запросов к api
<key>				- ключ доступа к api для взаимодействия
<task>				- имя выполняемой задачи
	users.sync 		- синхранизация пользователей из ldap
		<fields>	- id поля и имени аттрибута LDAP в формате id:name;id:name
		<container>	- контейнер пользователей в LDAP
		<auth>		- id режима аутентификации в приложении
		<format>	- формат отображения имён
	issues.change 	- изменение задач в сохранённом запросе
		<query>		- id сохранённого запроса для всех проектов
		<fields>	- поля и их значения в формате id:value;id:value с шаблонизацией
		<filters>	- фильтр в формате id:value;id:value с шаблонизацией

*/

// 0.3.15 конструктор основного приложения
function App(a){this.val=a};

// 0.1.0 библиотека функций общего назначения
(function(k,B){k.lib={strFirstUpperCase:function(a){return a.substr(0,1).toUpperCase()+a.substr(1)},clone:function(a){switch(!0){case k.lib.validate(a,"date"):var b=new Date(a);break;case k.lib.validate(a,"array"):b=[];for(var c=0,f=a.length;c<f;c++)b[c]=k.lib.clone(a[c]);break;case k.lib.validate(a,"object"):b={};for(c in a)b[c]="prototype"!==c?k.lib.clone(a[c]):a[c];break;default:b=a}return b},compare:function(a,b,c){var f=0;b||(b=null);switch(!0){case k.lib.validate(a,"string"):b=k.lib.convert(b,
"string");c&&(a=a.toLowerCase(),b=b.toLowerCase());break;case k.lib.validate(a,"array"):b=b&&b.length?b.length:0;a=a.length;break;case k.lib.validate(a,"date"):b=b&&b.valueOf()?b.valueOf():0,a=a.valueOf()}a>b&&(f=1);a<b&&(f=-1);return f},difference:function(a,b,c){var f;c||(c=k.lib.compare);if(k.lib.validate(a,"array")){b||(b=[]);for(var d=0,m=a.length;d<m;d++){var t=a[d];for(var g=0,h=b.length;g<h;g++){var n=b[g];if(value=c(t,n))f||(f=[]),f.push(t)}}}else if(k.lib.validate(a,"object"))for(d in b||
(b={}),a)t=a[d],n=b[d],value=k.lib.difference(t,n,c),k.lib.validate(value,"undefined")||(f||(f={}),f[d]=value);else(value=k.lib.compare(a,b))&&(f=a);return f},strim:function(a,b,c,f,d){var m="";a=a?a.toString():m;b=b?b.toString():m;c=c?c.toString():m;if(d){var k=c?a.lastIndexOf(c):a.length;d=b&&~k?a.lastIndexOf(b,k-1):0}else d=b?a.indexOf(b):0,k=c&&~d?a.indexOf(c,d+b.length):a.length;~d&&~k&&(d=f?d:d+b.length,k=f?k+c.length:k,m=a.substr(d,k-d));return m},trim:function(a){return(a||"").replace(/^\s+|\s+$/g,
"")},validate:function(a,b){var c;switch(b){case "email":b="^([a-z0-9_-]+.)*[a-z0-9_-]+@[a-z0-9_-]+(.[a-z0-9_-]+)*.[a-z]{2,6}$";break;case "password":b="(?=^.{8,}$)((?=.*d)|(?=.*W+))(?![.\n])(?=.*[A-Z])(?=.*[a-z]).*$";break;case "guid":b="^{[0-9a-fA-F]{8}(-[0-9a-fA-F]{4}){3}-[0-9a-fA-F]{12}}$";break;case "md5":b="^[0-9a-fA-F]{32}$"}switch(b){case "string":a="[object String]"===Object.prototype.toString.call(a);break;case "number":a="[object Number]"===Object.prototype.toString.call(a);break;case "boolean":a=
"[object Boolean]"===Object.prototype.toString.call(a);break;case "function":a="[object Function]"===Object.prototype.toString.call(a);break;case "form":a=!(!a||!a.tagName||"form"!==a.tagName.toLowerCase());break;case "files":a="[object FileList]"===Object.prototype.toString.call(a);break;case "date":a="[object Date]"===Object.prototype.toString.call(a);break;case "array":a=Array.isArray?Array.isArray(a):"[object Array]"===Object.prototype.toString.call(a);break;case "xml":a=!(!a||!(c=(a.ownerDocument||
a).documentElement)||"html"===c.nodeName.toLowerCase());break;case "undefined":a=void 0===a;break;case "null":a=null===a;break;case "object":a=a===Object(a)&&"[object Null]"!==Object.prototype.toString.call(a)&&"[object Date]"!==Object.prototype.toString.call(a)&&"[object Function]"!==Object.prototype.toString.call(a)&&"[object FileList]"!==Object.prototype.toString.call(a)&&"[object Array]"!==Object.prototype.toString.call(a)&&!(a&&(c=(a.ownerDocument||a).documentElement)&&"html"!==c.nodeName.toLowerCase())&&
!(a&&a.tagName&&"form"===a.tagName.toLowerCase());break;default:a=(new RegExp(b)).test(a)}return a},obj2str:function(a,b,c,f,d){var m=[];c||(c="&");f||(f="=");d||(d=",");for(var t in a){var g=a[t];var h=b?encodeURIComponent(t):t;switch(!0){case k.lib.validate(g,"array"):g=g.join(d);case !k.lib.validate(g,"undefined"):h+=f,h+=b?encodeURIComponent(g):g}m.push(h)}return m.join(c)},str2obj:function(a,b,c,f){var d,m={};c||(c="&");f||(f="=");c=a.split(c);for(var k=0,g=c.length;k<g;k++)if(d=c[k])d=d.split(f,
2),a=d[0],d=d[1],a=b?decodeURIComponent(a):a,d=b&&d?decodeURIComponent(d):d,m[a]=d;return m},url2obj:function(a){var b=a,c={},f=!1;a="fragment";var d="#";-1!=b.indexOf(d)&&(c[a]=k.lib.strim(b,d,null,!1),b=k.lib.strim(b,null,d,!1));a="query";d="?";-1!=b.indexOf(d)&&(c[a]=k.lib.strim(b,d,null,!1),b=k.lib.strim(b,null,d,!1));a="scheme";d="//";0==b.indexOf(d)&&(c[a]=k.lib.strim(b,null,d,!1),b=k.lib.strim(b,d,null,!1),f=!0);a="path";d="/";b.indexOf("://")>b.indexOf(d)&&(c[a]=k.lib.strim(b,d,null,!0),b=
k.lib.strim(b,null,d,!1));a="path";d="://";0==b.indexOf(d)&&(c[a]=k.lib.strim(b,d,null,!0),b=k.lib.strim(b,null,d,!1));a="scheme";d="://";!f&&0<b.indexOf(d)&&(c[a]=k.lib.strim(b,null,d,!1),b=k.lib.strim(b,d,null,!1),f=!0);a="path";d="/";f&&-1!=b.indexOf(d)&&(c[a]=k.lib.strim(b,d,null,!0),b=k.lib.strim(b,null,d,!1));a="path";d=b.length;!f&&0<d&&(c[a]=b,b="");d="@";if(-1!=b.indexOf(d)){var m=k.lib.strim(b,d,null,!1);b=k.lib.strim(b,null,d,!1);a="password";d=":";-1!=b.indexOf(d)&&(c[a]=k.lib.strim(b,
d,null,!1),b=k.lib.strim(b,null,d,!1));c.user=b;b=m}a="port";d=":";-1!=b.indexOf(d)&&(c[a]=k.lib.strim(b,d,null,!1),b=k.lib.strim(b,null,d,!1));f&&(c.domain=b);return c},obj2url:function(a){var b="";"user"in a&&(b="//");"password"in a&&(b="//");"domain"in a&&(b="//");"port"in a&&(b="//");var c="scheme";a[c]&&(b="://");var f=""+((a[c]?a[c]:"")+b);c="user";c in a&&(f+=""+a[c]);c="password";c in a&&(f+=":"+a[c]);b="";"user"in a&&(b="@");"password"in a&&(b="@");c="domain";f+=b+(a[c]?a[c]:"");c="port";
c in a&&(f+=":"+a[c]);c="path";c in a&&(f+=""+a[c]);c="query";c in a&&(f+="?"+a[c]);c="fragment";c in a&&(f+="#"+a[c]);return f},data2obj:function(a){var b={};a=a.split("\r\n");var c=a.shift().split("\t");for(var f=0;f<c.length;f++)c[f]=c[f].split(":"),c[f]={name:c[f][0],type:c[f][1]};f=0;for(var d=a.length;f<d;f++){var m=a[f].split("\t",c.length);var t={};for(var g=0;g<m.length;g++)t[c[g].name]=k.lib.convert(m[g],c[g].type);c[0]&&(b[t[c[0].name]]=t)}return b},obj2data:function(a){var b=[],c=[];split=
"\t";delim="\r\n";param=":";none=" ";for(var f in a){if(!b.length){var d=[];for(h in a[f]){var m=a[f][h];m="id"==h?"integer":k.lib.validate(m,"number")?"float":k.lib.validate(m,"boolean")?"boolean":k.lib.validate(m,"date")?"date":"string";b["id"==h?0:b.length]={name:h,type:m};d[d.length]=h+param+m}c[c.length]=d.join(split)}d=[];for(var t=0,g=b.length;t<g;t++){var h=b[t].name;m=a[f][h];for(m=k.lib.convert(m,"string");-1!=m.indexOf(split);)m=m.replace(split,none);for(;-1!=m.indexOf(delim);)m=m.replace(delim,
none);m=m.replace(/[\t\r\n]/g,none);d[d.length]=m}c[c.length]=d.join(split)}return c.join(delim)},obj2arr:function(a,b){var c=[];b||(b=function(a){return a});for(var f in a){var d=a[f];d=b(d,f,a);k.lib.validate(d,"undefined")||c.push(d)}return c},arr2obj:function(a,b,c){var f={};b||(b=function(a){return a});c||(c=function(a,b){return b});for(var d=0,m=a.length;d<m;d++){var t=a[d];var g=c(t,d,a);t=b(t,d,a);k.lib.validate(t,"undefined")||k.lib.validate(g,"undefined")||(f[g]=t)}return f},convert:function(a,
b){switch(b){case "bool":case "boolean":a="true"===a?!0:"false"===a?!1:!!a;break;case "int":case "integer":case "float":case "double":case "real":case "number":a=Number(a);break;case "date":a=new Date(1E3*Number(a));break;case "string":k.lib.validate(a,"boolean")?a=a?"true":"false":(k.lib.validate(a,"date")&&(a=a.valueOf()/1E3),a=a.toString())}return a},xhr:function(a,b,c,f,d,m,t,g){var h,n=6E5,p=0;var e=h={responseText:""};var v=null;if(!p){var r=a?""+a:"get";a=r.toUpperCase();switch(a.toLowerCase()){case "get":v=
!0;break;case "head":v=!0;break;case "delete":v=!0}}if(!p){var q=function(){};var u={upload:q,download:q,success:q,error:q,complete:q};if(k.lib.validate(m,"function"))u.complete=m;else if(m)for(w in u)q=m[w],k.lib.validate(q,"function")&&(u[w]=q);m=u}if(!p){u={"X-Requested-With":"XMLHttpRequest"};if(!1===c){var w="X-Requested-With";w in u&&delete u[w]}if(k.lib.validate(c,"object"))for(w in c)switch(q=c[w],w.toLowerCase()){case "cookie":break;case "host":break;default:u[w]=q}c=u}if(!p){f=f?f:"";if(k.lib.validate(f,
"form")){u={};for(var x=0,z=f.elements.length;x<z;x++)q=f.elements[x],q.name&&!q.disabled&&(w=(""+q.type).toLowerCase(),"checkbox"==w||"radio"==w?q.checked&&(u[q.name]=q.value?q.value:!0):u[q.name]=q.files&&q.files.length?q.files:q.value?q.value:B);f=u}k.lib.validate(f,"xml")&&(v=!1,c["Content-Type"]="application/xml",f.xml?f=f.xml:(u=new XMLSerializer,f=u.serializeToString(f)));if(k.lib.validate(f,"object")){u=!1;for(w in f)if(q=f[w],k.lib.validate(q,"files")){v=!1;u=!0;break}if(u)for(w in u=new FormData,
f)if(q=f[w],k.lib.validate(q,"files")){var y=f[w];x=0;for(z=y.length;x<z;x++)q=y[x],u.append(w,q)}else k.lib.validate(q,"undefined")&&(q=""),u.append(w,q);else f=k.lib.obj2str(f,!0),!v&&f&&(c["Content-Type"]="application/x-www-form-urlencoded")}}p||(r=b?""+b:"",v&&f&&(r=r?~r.indexOf("?")?r+"&":r+"?":r+"?",r+=f,f=""),b=r);if(!p){u=null;if(!u)try{u=new XMLHttpRequest}catch(A){}if(!u)for(v="$#!&%",y=["Ms$#!&%xm$#!&%l2$#!&%.XM$#!&%LHT$#!&%TP.6.0","Ms$#!&%xm$#!&%l2$#!&%.XM$#!&%LHT$#!&%TP.3.0","Ms$#!&%xm$#!&%l2$#!&%.XM$#!&%LHT$#!&%TP",
"Micr$#!&%osoft$#!&%.XM$#!&%LH$#!&%TTP"],x=0,z=y.length;!u&&x<z;x++){q=y[x];r=q.split(v).join("");try{u=new ActiveXObject(r)}catch(A){}}u?e=u:p=1}if(!p){try{n=setTimeout(function(){r=e.responseText?e.responseText:"";e.abort();m.error(r,e);m.complete(r,e)},n)}catch(A){}e.upload&&(e.upload.onprogress=function(a){a.total&&a.loaded!=a.total&&m.upload(a,e)},e.onprogress=function(a){a.total&&a.loaded!=a.total&&m.download(a,e)});e.onreadystatechange=function(a){if(4==e.readyState){try{clearTimeout(n)}catch(C){}w=
e.status?e.status:200;r=e.responseText?e.responseText:"";200<=w&&300>w&&r?m.success(r,e):m.error(r,e);m.complete(r,e)}}}if(!p)try{g?e.open(a,b,d,t,g):t?e.open(a,b,d,t):e.open(a,b,d)}catch(A){e=h,p=2}if(!p)for(w in c)r=c[w],v="; ",k.lib.validate(r,"array")&&(y=r,r=y.join(v)),e.setRequestHeader(w,r);if(!p)try{f?e.send(f):e.send()}catch(A){e=h,p=3}if(1<p)try{clearTimeout(n)}catch(A){}p&&(r="",m.error(r,e),m.complete(r,e));return e},ajax:function(a,b,c,f,d){return k.lib.xhr(a,b,c,f,!0,d)},sjax:function(a,
b,c,f){return k.lib.xhr(a,b,c,f,!1)},strPad:function(a,b,c,f){var d,m=d="",k=function(a,b){for(;m.length<b;)m+=a;return m=m.substr(0,b)};a=""+a;c=c?""+c:" ";"left"!=f&&"right"!=f&&"both"!=f&&(f="right");0<(d=b-a.length)&&("left"==f?a=k(c,d)+a:"right"==f?a+=k(c,d):"both"==f&&(d=k(c,Math.ceil(d/2)),a=(d+a+a).substr(0,b)));return a},getCookie:function(a,b){var c=document.cookie.indexOf(a+"="),f=c+a.length+1;if(!c&&a!=document.cookie.substring(0,a.length)||-1==c)return null;a=document.cookie.indexOf(";",
f);-1==a&&(a=document.cookie.length);return b?decodeURIComponent(document.cookie.substring(f,a)):unescape(document.cookie.substring(f,a))},setCookie:function(a,b,c,f,d,m,k){var g=new Date((new Date).valueOf()+c);document.cookie=a+"="+(k?encodeURIComponent(b):escape(b))+(c?";expires="+g.toGMTString():"")+(f?";path="+f:"")+(d?";domain="+d:"")+(m?";secure":"");return!0},delCookie:function(a,b,c){k.lib.getCookie(a)&&(document.cookie=a+"="+(b?";path="+b:"")+(c?";domain="+c:"")+";expires=Thu, 01-Jan-1970 00:00:01 GMT");
return!0},getStorage:function(a,b){var c,f=null,d=null;if(c=window&&window.localStorage?localStorage.getItem(a):k.lib.getCookie(a)){var m=c.indexOf("?");-1!=m&&(type=c.substr(0,m),c=c.substr(m+1));b?(c=c.split("&"),!0!==b&&(c.length=Math.min(b,c.length))):c=[c];for(var t=0,g=c.length;t<g;t++){m=c[t].indexOf("=");if(-1!=m){if(a=c[t].substr(0,m),a=decodeURIComponent(a),f=c[t].substr(m+1),!d){var h=!0;d={}}}else a=t,f=c[t],d||(h=!1,d=[]);f=decodeURIComponent(f);type&&(f=k.lib.convert(f,type));h?d[a]=
f:d.push(f)}}else d=null;return b?d:f},setStorage:function(a,b){var c,f=[];var d=function(a,b){c||(c=k.lib.validate(a,"number")?"number":k.lib.validate(a,"date")?"date":k.lib.validate(a,"boolean")?"boolean":"string");a=k.lib.convert(a,"string");a=encodeURIComponent(a);k.lib.validate(b,"undefined")?f.push(a):(b=encodeURIComponent(b),f.push(b+"="+a))};if(k.lib.validate(b,"object"))for(var m in b)d(b[m],m);else if(k.lib.validate(b,"array")){m=0;for(var t=b.length;m<t;m++)d(b[m])}else k.lib.validate(b,
"null")||d(b);if(f=f.join("&"))if(f=c+"?"+f,window&&window.localStorage)try{localStorage.setItem(a,f);var g=!0}catch(h){g=!1}else g=k.lib.setCookie(a,f,31536E7,location.pathname,document.domain);else window&&window.localStorage?(localStorage.removeItem(a),g=!0):g=k.lib.delCookie(a,location.pathname,document.domain);return g},counter:function(){var a={};return function(b,c){var f=0;k.lib.validate(b,"array")&&b.join("_");b&&(a[b]=a[b]||0,f=a[b],!1===c?delete a[b]:!0===c?a[b]++:c&&(a[b]+=c));return f}}(),
on:function(){var a={};return function(b,c,f){var d,m=[],k=0;b=b.toString().split(/\s+/);for(var g=0,h=b.length;g<h;g++)if(d=b[g])if(a[d]||(a[d]=[0]),f)if(c){a[d][c]||(a[d][c]=[]);var n=a[d][c].length;a[d][c][n]=f;a[d][0]>=c&&m.push([d,c,n]);k++}else{n=1;for(var p=a[d].length;n<p;n++)if(a[d][n])for(var e=0,v=a[d][n].length;e<v;e++)a[d][n][e]===f&&(delete a[d][n][e],k++)}else if(a[d][0]++,c=c||a[d][0],a[d][c])for(n=0;n<a[d][c].length;n++)a[d][c][n]&&m.push([d,c,n]),k++;g=0;for(h=m.length;g<h;g++)d=
m[g][0],c=m[g][1],n=m[g][2],a[d]&&a[d][c]&&a[d][c][n]&&a[d][c][n].call(a[d][c][n],c);return k}}(),href:function(a){var b=document.createElement("a");b.href=a;return b.cloneNode(!1).href},getExt:function(a){var b="";var c=(""+a).lastIndexOf(".");-1!==c&&(b=a.substr(c+1),b=b.toLowerCase());return b},md5:function(a){var b=function(a,b){var c=a&2147483648;var d=b&2147483648;var f=a&1073741824;var g=b&1073741824;a=(a&1073741823)+(b&1073741823);return f&g?a^2147483648^c^d:f|g?a&1073741824?a^3221225472^
c^d:a^1073741824^c^d:a^c^d},c=function(a,c,d,f,g,e,h){a=b(a,b(b(c&d|~c&f,g),h));return b(a<<e|a>>>32-e,c)},f=function(a,c,d,f,g,e,h){a=b(a,b(b(c&f|d&~f,g),h));return b(a<<e|a>>>32-e,c)},d=function(a,c,d,f,g,e,h){a=b(a,b(b(c^d^f,g),h));return b(a<<e|a>>>32-e,c)},m=function(a,c,d,f,g,e,h){a=b(a,b(b(d^(c|~f),g),h));return b(a<<e|a>>>32-e,c)},k=function(a){var b="",c;for(c=0;3>=c;c++){var d=a>>>8*c&255;d="0"+d.toString(16);b+=d.substr(d.length-2,2)}return b},g=[];a=function(a){a=a.replace(/\r\n/g,"\n");
for(var b="",c=0;c<a.length;c++){var d=a.charCodeAt(c);128>d?b+=String.fromCharCode(d):(127<d&&2048>d?b+=String.fromCharCode(d>>6|192):(b+=String.fromCharCode(d>>12|224),b+=String.fromCharCode(d>>6&63|128)),b+=String.fromCharCode(d&63|128))}return b}(a.toString());g=function(a){var b=a.length;var c=b+8;for(var d=16*((c-c%64)/64+1),f=Array(d-1),g,e=0;e<b;)c=(e-e%4)/4,g=e%4*8,f[c]|=a.charCodeAt(e)<<g,e++;c=(e-e%4)/4;f[c]|=128<<e%4*8;f[d-2]=b<<3;f[d-1]=b>>>29;return f}(a);var h=1732584193;var n=4023233417;
var p=2562383102;var e=271733878;for(a=0;a<g.length;a+=16){var v=h;var r=n;var q=p;var u=e;h=c(h,n,p,e,g[a+0],7,3614090360);e=c(e,h,n,p,g[a+1],12,3905402710);p=c(p,e,h,n,g[a+2],17,606105819);n=c(n,p,e,h,g[a+3],22,3250441966);h=c(h,n,p,e,g[a+4],7,4118548399);e=c(e,h,n,p,g[a+5],12,1200080426);p=c(p,e,h,n,g[a+6],17,2821735955);n=c(n,p,e,h,g[a+7],22,4249261313);h=c(h,n,p,e,g[a+8],7,1770035416);e=c(e,h,n,p,g[a+9],12,2336552879);p=c(p,e,h,n,g[a+10],17,4294925233);n=c(n,p,e,h,g[a+11],22,2304563134);h=c(h,
n,p,e,g[a+12],7,1804603682);e=c(e,h,n,p,g[a+13],12,4254626195);p=c(p,e,h,n,g[a+14],17,2792965006);n=c(n,p,e,h,g[a+15],22,1236535329);h=f(h,n,p,e,g[a+1],5,4129170786);e=f(e,h,n,p,g[a+6],9,3225465664);p=f(p,e,h,n,g[a+11],14,643717713);n=f(n,p,e,h,g[a+0],20,3921069994);h=f(h,n,p,e,g[a+5],5,3593408605);e=f(e,h,n,p,g[a+10],9,38016083);p=f(p,e,h,n,g[a+15],14,3634488961);n=f(n,p,e,h,g[a+4],20,3889429448);h=f(h,n,p,e,g[a+9],5,568446438);e=f(e,h,n,p,g[a+14],9,3275163606);p=f(p,e,h,n,g[a+3],14,4107603335);
n=f(n,p,e,h,g[a+8],20,1163531501);h=f(h,n,p,e,g[a+13],5,2850285829);e=f(e,h,n,p,g[a+2],9,4243563512);p=f(p,e,h,n,g[a+7],14,1735328473);n=f(n,p,e,h,g[a+12],20,2368359562);h=d(h,n,p,e,g[a+5],4,4294588738);e=d(e,h,n,p,g[a+8],11,2272392833);p=d(p,e,h,n,g[a+11],16,1839030562);n=d(n,p,e,h,g[a+14],23,4259657740);h=d(h,n,p,e,g[a+1],4,2763975236);e=d(e,h,n,p,g[a+4],11,1272893353);p=d(p,e,h,n,g[a+7],16,4139469664);n=d(n,p,e,h,g[a+10],23,3200236656);h=d(h,n,p,e,g[a+13],4,681279174);e=d(e,h,n,p,g[a+0],11,3936430074);
p=d(p,e,h,n,g[a+3],16,3572445317);n=d(n,p,e,h,g[a+6],23,76029189);h=d(h,n,p,e,g[a+9],4,3654602809);e=d(e,h,n,p,g[a+12],11,3873151461);p=d(p,e,h,n,g[a+15],16,530742520);n=d(n,p,e,h,g[a+2],23,3299628645);h=m(h,n,p,e,g[a+0],6,4096336452);e=m(e,h,n,p,g[a+7],10,1126891415);p=m(p,e,h,n,g[a+14],15,2878612391);n=m(n,p,e,h,g[a+5],21,4237533241);h=m(h,n,p,e,g[a+12],6,1700485571);e=m(e,h,n,p,g[a+3],10,2399980690);p=m(p,e,h,n,g[a+10],15,4293915773);n=m(n,p,e,h,g[a+1],21,2240044497);h=m(h,n,p,e,g[a+8],6,1873313359);
e=m(e,h,n,p,g[a+15],10,4264355552);p=m(p,e,h,n,g[a+6],15,2734768916);n=m(n,p,e,h,g[a+13],21,1309151649);h=m(h,n,p,e,g[a+4],6,4149444226);e=m(e,h,n,p,g[a+11],10,3174756917);p=m(p,e,h,n,g[a+2],15,718787259);n=m(n,p,e,h,g[a+9],21,3951481745);h=b(h,v);n=b(n,r);p=b(p,q);e=b(e,u)}return(k(h)+k(n)+k(p)+k(e)).toLowerCase()},parseJSON:function(a){if(window&&window.JSON&&JSON.parse)try{var b=JSON.parse(a)}catch(c){b=eval("("+a+")")}else b=eval("("+a+")");return b},numDeclin:function(a,b,c,f){a=Number(a);a=
Math.abs(a);a=Math.floor(a);var d=a%10;return 1!=(a%100-d)/10?0==d?b:1==d?c:5>d?f:b:b},num2str:function(a,b,c,f){var d,m;isNaN(b=Math.abs(b))&&(b=2);c==B&&(c=",");f==B&&(f=".");if(m=0>a)a=Math.abs(a);var k=parseInt(a=(+a||0).toFixed(b))+"";var g=(d=3<(d=k.length)?d%3:0)?k.substr(0,d)+f:"";f=k.substr(d).replace(/(\d{3})(?=\d)/g,"$1"+f);a=b?c+Math.abs(a-k).toFixed(b).replace(/-/,0).slice(2):"";return(m?"-":"")+g+f+a},num2word:function(a,b,c){function f(a,b){a=a.toString().substr(-2);return b[0]+(/^[0,2-9]?[1]$/.test(a)?
b[2]:/^[0,2-9]?[2-4]$/.test(a)?b[3]:b[1])}var d=[],m=[["ноль"],[,,,"три","четыре","пять","шесть","семь","восемь","девять"],"десять одиннадцать двенадцать тринадцать четырнадцать пятнадцать шестнадцать семнадцать восемнадцать девятнадцать".split(" "),[,,"двадцать","тридцать","сорок","пятьдесят","шестьдесят","семьдесят","восемьдесят","девяносто"],[,"сто","двести","триста","четыреста","пятьсот","шестьсот","семьсот","восемьсот","девятьсот"],[[,"один","два"],[,"одна","две"],[,"одно","два"]]],k=[["...ллион",
"ов","","а"],["тысяч","","а","и"],["миллион","ов","","а"],["миллиард","ов","","а"],["триллион","ов","","а"],["квадриллион","ов","","а"],["квинтиллион","ов","","а"],["секстилион","ов","","а"],["септилион","ов","","а"],["окталион","ов","","а"],["ноналион","ов","","а"],["декалион","ов","","а"],["эндекалион","ов","","а"],["додекалион","ов","","а"]],g=[[["цел","ых","ый","ых"],["цел","ых","ая","ых"],["цел","ых","ое","ых"]],["десят","ых","ая","ых"],["сот","ых","ая","ых"],["тясячн","ых","ая","ых"],["десятитысячн",
"ых","ая","ых"],["стотысячн","ых","ая","ых"],["милионн","ых","ая","ых"],["десятимилионн","ых","ая","ых"]];c=c||0;a=a.toString().split(".");for(var h=0,n=a.length;h<n;h++){h&&(a[h]=a[h].substr(0,g.length-1));l=a[h].length;a[h]=["","00","0"][a[h].split(/\d{3}/).join("").length]+a[h];for(var p=a[h].length,e,v=0,r=-1,q=[];3*v<p;){e=a[h].substr(-3*(v+1),3);q[++r]=[];for(var u=0;2>=u;u++)if(0!=e[u])switch(u){case 0:q[r][q[r].length]=m[4][e[u]];break;case 1:1==e[u]?(q[r][q[r].length]=m[2][e[2]],u=3):q[r][q[r].length]=
m[3][e[u]];break;case 2:q[r][q[r].length]=2>=e[u]?m[5][1==v||h?1:c][e[u]]:m[1][e[u]]}q[r].length||(q[r][q[r].length]=m[0][0]);0<e&&0<v&&(q[r][q[r].length]=f(e,k[v]));!v&&1<n&&(q[r][q[r].length]=f(e,h?g[l]:g[0][c]));v||!b||h||h!=n-1?!v&&b&&h&&(q[r][q[r].length]=b[0]+b[3]):q[r][q[r].length]=f(e,b);q[r]=q[r].join(" ");v++}d[d.length]=q.reverse().join(" ")}return d.join(" ")},date2str:function(a,b){var c="Воскресенье Понедельник Вторник Среда Четверг Пятница Суббота".split(" "),f=" Января Февраля Марта Апреля Мая Июня Июля Августа Сентября Октября Ноября Декабря".split(" "),
d={0:"ый",2:"ой",3:"ий",6:"ой",7:"ой",8:"ой",22:"ой",26:"ой",27:"ой",28:"ой"},m={"-660":"ST","-600":"HAST","-540":"AKT","-480":"AWST","-420":"CXT","-360":"СST","-300":"EST","-240":"AST","-210":"NST","-180":"ART",0:"GMT",60:"CET",120:"CAT",180:"MSK",210:"IRST",300:"PKT",330:"IST",360:"BDT",390:"MST",420:"CXT",480:"AWST",540:"JST",570:"ACST",600:"AEST",660:"NFT"},t="";var g=function(b){var e="";switch(b){case "d":e+=k.lib.strPad(g("j"),2,"0","left");break;case "D":e+=g("l").substr(0,3);break;case "j":e+=
a.getDate();break;case "l":e+=c[g("w")];break;case "N":e+=g("w")||7;break;case "S":e+=d[g("j")]||d[0];break;case "w":e+=a.getDay();break;case "z":e+=(a-new Date(a.getFullYear(),0,1))/864E5>>0;break;case "W":b=new Date(a.valueOf());var h=(a.getDay()+6)%7;b.setDate(b.getDate()-h+3);h=b.valueOf();b.setMonth(0,1);4!==b.getDay()&&b.setMonth(0,1+(4-b.getDay()+7)%7);e+=1+Math.ceil((h-b)/6048E5);break;case "F":e+=f[g("n")];break;case "m":e+=k.lib.strPad(g("n"),2,"0","left");break;case "M":e+=g("F").substr(0,
3);break;case "n":e+=a.getMonth()+1;break;case "t":e+=(new Date(a.getFullYear(),a.getMonth()+1,0)).getDate();break;case "L":e+=a.getFullYear()&3||!(a.getFullYear()%100)&&a.getFullYear()%400?0:1;break;case "o":(function(){var b=new Date(a.valueOf());b.setDate(b.getDate()-(a.getDay()+6)%7+3);e+=b.getFullYear()})();break;case "Y":e+=a.getFullYear();break;case "y":e+=g("Y").substr(2,2);break;case "a":e+=11<a.getHours()?"pm":"am";break;case "A":e+=g("a").toUpperCase();break;case "B":(function(){var b=
60*(a.getTimezoneOffset()+60);b=3600*a.getHours()+60*a.getMinutes()+a.getSeconds()+b;b=Math.floor(b/86.4);1E3<b&&(b-=1E3);0>b&&(b+=1E3);e+=k.lib.strPad(b,3,"0","left")})();break;case "g":e+=a.getHours()%12||12;break;case "G":e+=a.getHours();break;case "h":e+=k.lib.strPad(g("g"),2,"0","left");break;case "H":e+=k.lib.strPad(g("G"),2,"0","left");break;case "i":e+=k.lib.strPad(a.getMinutes(),2,"0","left");break;case "s":e+=k.lib.strPad(a.getSeconds(),2,"0","left");break;case "u":e+=k.lib.strPad(1E3*a.getMilliseconds(),
6,"0","left");break;case "e":e+=(new Date).toString().split(" ")[5].split("-")[0].split("+")[0];break;case "I":e+=(new Date(a.getFullYear(),0,1)).getTimezoneOffset()!=a.getTimezoneOffset()?1:0;break;case "O":e+=(0<a.getTimezoneOffset()?"-":"+")+k.lib.strPad(Math.abs(a.getTimezoneOffset()/60*100),4,"0","left");break;case "P":e+=g("O").substr(0,3)+":"+g("O").substr(3,2);break;case "T":e+=m[-1*a.getTimezoneOffset()-60*Number(g("I"))]||m[0];break;case "Z":e+=-60*a.getTimezoneOffset();break;case "c":e+=
g("Y")+"-"+g("m")+"-"+g("d")+"T"+g("h")+":"+g("i")+":"+g("s")+g("P");break;case "r":e+=g("D")+", "+g("j")+" "+g("M")+" "+g("Y")+" "+g("h")+":"+g("i")+":"+g("s")+" "+g("O");break;case "U":e+=Math.round(a.getTime()/1E3)}return e};for(var h=0,n=b.length;h<n;h++){var p=b.charAt(h);t="\\"!==e?t+(g(p)||p):t+p;var e=p}return t},extend:function(){var a=arguments[0]||{},b=1,c=arguments.length,f=!1,d;k.lib.validate(a,"boolean")&&(f=a,a=arguments[1]||{},b=2);for(k.lib.validate(a,"object")||k.lib.validate(a,
"function")||(a={});b<c;++b)if(null!=(d=arguments[b]))for(var m in d){var t=a[m],g=d[m];a!==g&&(f&&g&&k.lib.validate(g,"object")&&!g.nodeType?a[m]=k.lib.extend(f,t||(null!=g.length?[]:{}),g):k.lib.validate(g,"undefined")||(a[m]=g))}return a},template:function(a,b){var c;if(a){b||(b={});a=a.toString();var f=a.split("|");for(var d=f.length,m=d-1;-1<m;m--)if(c=f[m]){a=!0;var k=c.split("{");for(var g=1,h=k.length;g<h;g++){var n=k[g];var p=n.indexOf("}");if(~p){var e=n.substr(0,p);c=b;var v=e.split(".");
for(var r=0,q=v.length;a&&r<q;r++)e=v[r],(a=e in c)&&(c=c[e]);a&&(p+=1,n=c+n.substr(p))}else n="{"+n;k[g]=n}c=k.join("");a?f[m]=c:f.splice(m,1)}else m&&m<d-1&&(f[m]="|");b=f.join("")}else b="";return b},getRandomString:function(a,b){var c="";b||(b=89);b=Math.min(Math.max(b,1),89);for(var f=0;f<a;f++)c+="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ!@#$%^&*()-_+=;:,./?|`~[]{}".charAt(Math.round(Math.random()*(b-1)));return c}}})(App.prototype);

// 0.1.0 функци для работы в среде windows script host
(function(q,t,u){q.wsh={getLDAP:function(a,d,f,b,g){var m=[],n=[],c=0;if(!c){var e=new ActiveXObject("ADODB.Connection");var r=new ActiveXObject("NameTranslate");var h=new ActiveXObject("ADODB.Command")}c||(e.provider="ADsDSOObject",b&&(e.properties("User ID").value=b),g&&(e.properties("Password").value=g),e.open("Active Directory Provider"),h.activeConnection=e,h.properties("Searchscope").value=2,h.properties("Page Size").value=100);if(!c)if(f)var l=f;else f=GetObject("LDAP://RootDSE"),l=f.get("DefaultNamingContext");
c||(n=[a],d&&n.push(d));for(g=n.length-1;!c&&-1<g;g--){a=n[g];d=f=null;e="SELECT distinguishedName FROM 'LDAP://"+l+"'";if(!c&&a&&!d&&q.lib.validate(a,"guid")){b=(""+a).toUpperCase();try{r.init(3,""),r.set(7,b),d=r.get(1)}catch(p){c=1}}if(!c&&a&&!d)try{(d=a.get("distinguishedName"))&&(f=a)}catch(p){}if(!c&&a&&!d){b=e+" WHERE name = '"+a+"' OR sAMAccountName = '"+a+"' OR distinguishedName = '"+a+"'";try{h.commandText=b;var k=h.execute();k.recordCount&&(d=k.fields("distinguishedName").value)}catch(p){}}if(!c&&
!d){a?(b=""+a,b=q.lib.template(b,{protocol:"LDAP:",parent:l,select:e}),b.toUpperCase().indexOf("WHERE")||(b=e+" "+b)):b=g?e+" WHERE distinguishedName = '"+l+"'":e;try{h.commandText=b,k=h.execute(),k.recordCount||(c=3)}catch(p){c=2}}if(!c&&d&&!g)if(f)m.push(f);else{b=d;try{f=GetObject("LDAP://"+b),m.push(f)}catch(p){c=4}}if(!c&&!d)for(a=0,e=k.recordCount;a<e;k.moveNext(),a++)b=k.fields("distinguishedName").value,a||(d=b),!g&&a&&(f=GetObject("LDAP://"+b),m.push(f));c||(l=d)}return m}}})(App.prototype,
WSH);

// 0.1.0 взаимодействие с redmine по средствам api
var readmine=new App({apiKey:null,apiUrl:null,delimVal:":",delimKey:";",delimId:".",stActive:1,stRegistered:2,stLocked:3});
(function(d,q,y){d.lib.extend(d,{cache:{user:{}},fun:{str2val:function(a){switch(!0){case "true"==a:a=!0;break;case "false"==a:a=!1;break;case !isNaN(a):a=Number(a);break;case "--"==a.charAt(4)+a.charAt(7)&&"::"==a.charAt(13)+a.charAt(16)&&"TZ"==a.charAt(10)+a.charAt(19):a=Date.UTC(Number(a.substr(0,4)),Number(a.substr(5,2)),Number(a.substr(8,2)),Number(a.substr(11,2)),Number(a.substr(14,2)),Number(a.substr(17,2))),a=new Date(a)}return a},val2str:function(a){switch(!0){case d.lib.validate(a,"string"):case d.lib.validate(a,
"number"):a=""+a;break;case d.lib.validate(a,"boolean"):a=a?"true":"false";break;case d.lib.validate(a,"date"):a=a.getUTCFullYear()+"-"+d.lib.strPad(a.getUTCMonth(),2,"0","left")+"-"+d.lib.strPad(a.getUTCDate(),2,"0","left")+"T"+d.lib.strPad(a.getUTCHours(),2,"0","left")+":"+d.lib.strPad(a.getUTCMinutes(),2,"0","left")+":"+d.lib.strPad(a.getUTCSeconds(),2,"0","left")+"Z";break;default:a=null}return a},xml2obj:function(a){var f={},g=null,k=!0;if(a){var e=a.documentElement?a.documentElement:a;for(var c=
0,b=e.attributes.length;c<b;c++){var m=e.attributes[c];k=!1;"type"!=m.name&&"array"!=m.value?f[m.name]=d.fun.str2val(m.value):a.documentElement||(g=!0)}g&&(f=[]);c=0;for(b=a.childNodes.length;c<b;c++)switch(e=a.childNodes[c],e.nodeType){case 1:k=!1;m=d.fun.xml2obj(e);g?f.push(m):f[e.nodeName]=m;break;case 3:k=!1,f=d.fun.str2val(e.nodeValue)}}else k=!1;return k?null:f},obj2xml:function(a,f){var g="item",k=null,e=null;var c={custom_fields:"custom_field",memberships:"membership",groups:"group",issues:"issue",
users:"user",roles:"role"};if(f)f.ownerDocument&&(k=f.ownerDocument);else{var b=["MSXML2.DOMDocument.6.0","MSXML2.DOMDocument.3.0","MSXML2.DOMDocument"];for(var m=0,p=b.length;!k&&m<p;m++){var h=b[m];try{k=new ActiveXObject(h)}catch(z){}}b=k.createProcessingInstruction("xml",'version="1.0" encoding="UTF-8"');k.appendChild(b)}if(k){e=k.createDocumentFragment();if(d.lib.validate(a,"array"))for(f&&(f.setAttribute("type","array"),b=f.nodeName,g=c[b]?c[b]:g),m=0,p=a.length;m<p;m++){var l=k.createElement(g);
for(var n in a[m])switch(h=a[m][n],b=d.fun.val2str(h),!0){case "value"==n&&"custom_field"==g:case "membership"==g:case "user"==g:b=h,h={},h[n]=b;case !b:b=d.fun.obj2xml(h,l);l.appendChild(b);break;default:l.setAttribute(n,b)}e.appendChild(l)}if(d.lib.validate(a,"object")){f&&(g=f.nodeName);for(n in a)switch(h=a[n],b=d.fun.val2str(h),!0){case !!b&&"project"==g:case !!b&&"tracker"==g:case !!b&&"priority"==g:case !!b&&"author"==g:case !!b&&"category"==g:f&&f.setAttribute(n,b);break;case !!f||!l&&!b:l=
k.createElement(n),b=b?k.createTextNode(b):d.fun.obj2xml(h,l),l.appendChild(b),e.appendChild(l)}if(!f&&l)for(n in a)h=a[n],(b=d.fun.val2str(h))&&l.setAttribute(n,b)}f||k.appendChild(e)}return f?e:k},item2user:function(a,f,g){var k,e={};var c=0;g||(g="lastname_firstname");c||a||(c=1);c||f||(c=2);if(!c){var b=a.get("userAccountControl");e.status=b&2?d.val.stLocked:d.val.stActive;var m=a.get("distinguishedName");d.cache.user[m]=e}if(!c)for(var p in f){c=f[p];b=null;try{b=a.get(c)}catch(h){}switch(c){case "manager":if(c=
null,b&&b!=m&&(c=d.cache.user[b],!c&&(k=d.wsh.getLDAP(b)[0]))&&(c=d.fun.item2user(k,f,g),d.cache.user[b]=c),b=null,k=c&&d.val.stActive==c.status)switch(g){case "firstname_lastname":b=[c.firstname,c.lastname].join(" ");break;case "firstname_lastinitial":b=[c.firstname,c.lastname.charAt(0)+"."].join(" ");break;case "firstinitial_lastname":b=[c.firstname.charAt(0)+".",c.lastname].join(" ");break;case "firstname":b=c.firstname;break;case "lastname_firstname":b=[c.lastname,c.firstname].join(" ");break;
case "lastnamefirstname":b=[c.lastname,c.firstname].join("");break;case "lastname_comma_firstname":b=[c.lastname,c.firstname].join(", ");break;case "lastname":b=c.lastname;break;case "username":b=c.login}}isNaN(p)?e[p]=b:(e.custom_fields||(e.custom_fields=[]),e.custom_fields.push({id:p,value:b}))}return e}},task:{"users.sync":function(a,f,g,k){var e,c={},b=0,m=0;if(!m)if(a=a?d.lib.str2obj(a,!1,d.val.delimKey,d.val.delimVal):{},a.login&&a.firstname&&a.lastname&&a.mail)for(var p in a){var h=a[p].split("'").join("");
a[p]=h}else m=1;m||(e=d.wsh.getLDAP("WHERE 'objectClass' = 'user' AND '"+a.firstname+"' = '*' AND '"+a.lastname+"' = '*' AND '"+a.login+"' = '*' AND '"+a.mail+"' = '*'",f));h=0;for(p=e.length;!m&&h<p;h++){f=e[h];var l=d.fun.item2user(f,a,k);if(l.login){var n=l.login.toLowerCase();c[n]=l}else m=2}k=[d.val.stActive,d.val.stRegistered,d.val.stLocked];e=[];h=0;for(p=k.length;!m&&h<p;h++)for(l=k[h],a=null;!a||a.total_count>a.offset;a.offset+=a.limit){a={offset:a?a.offset:0,status:l};a=d.api("get","users",
a);a.users||(a.users=[]);for(var q=0,w=a.users.length;q<w;q++)f=a.users[q],f.status=l,e.push(f)}m||e.length||(m=3);h=0;for(p=e.length;!m&&h<p;h++)if(f=e[h],n=f.login.toLowerCase(),l=c[n]){if(a=d.lib.difference(l,f,function(a,b){return a.id==b.id&&a.value!=b.value}))g&&(a.auth_source_id=g),a={user:a},a=d.api("put","users/"+f.id,a),a.user&&b++;delete c[n]}if(!m)for(n in c)l=c[n],d.val.stActive==l.status&&(g&&(l.auth_source_id=g),a={user:l},a=d.api("post","users",a),a.user&&b++),delete c[n];return b},
"issues.change":function(a,f,g){var k,e,c=0,b=0;var m={project:"project_id",tracker:"tracker_id",status:"status_id",priority:"priority_id",author:"author_id",assigned:"assigned_to_id",category:"category_id",start:"start_date",due:"due_date",done:"done_ratio",private:"is_private",estimated:"estimated_hours",version:"fixed_version_id",parent:"parent_issue_id"};var p={start:"start_date",due:"due_date",done:"done_ratio",private:"is_private",estimated:"estimated_hours",created:"created_on",updated:"updated_on",
closed:"closed_on"};if(!b)if(f=f?d.lib.str2obj(f,!1,d.val.delimKey,d.val.delimVal):null)for(var h in f){var l=f[h].split('"').join("");f[h]=d.fun.str2val(l)}else b=1;if(!b&&(g=g?d.lib.str2obj(g,!1,d.val.delimKey,d.val.delimVal):null))for(h in g)l=g[h].split('"').join(""),g[h]=d.fun.str2val(l);if(!b){var n=[];for(e=null;!e||e.total_count>e.offset;e.offset+=e.limit)e={offset:e?e.offset:0},a&&(e.query_id=a),e=d.api("get","issues",e),e.issues&&(n=n.concat(e.issues))}for(var q=0,w=n.length;!b&&q<w;q++){var u=
n[q];for(k in u){var r=u[k];(k=p[k]?p[k]:null)&&(u[k]=r)}var t=!0;if(g)for(h in g){a=g[h];if(isNaN(h))for(l=e=u,list=h.split(d.val.delimId),v=0,x=list.length;t&&v<x;v++)k=list[v],(t=k in e)&&(l=e=e[k]);else{t=!1;list=u.custom_fields?u.custom_fields:[];for(var v=0,x=list.length;!t&&v<x;v++)if(r=list[v],t=r.id==Number(h))l=r.value}t&&(d.lib.validate(a,"string")&&(a=d.lib.template(a,u)),t=!d.lib.compare(l,a),t||(a=""+a,l=""+l,a=a.toLowerCase(),t=~l.toLowerCase().indexOf(a)));if(!t)break}if(t)for(h in r=
null,f)l=f[h],d.lib.validate(l,"string")&&(l=d.lib.template(l,u)),h=m[h]?m[h]:h,r||(r={}),isNaN(h)?r[h]=l:(r.custom_fields||(r.custom_fields=[]),r.custom_fields.push({id:h,value:l}));t&&(e={issue:r},e=d.api("put","issues/"+u.id,e),e.issue&&c++)}return c}},api:function(a,f,g){var k={},e=0;if(!e)switch(a.toLowerCase()){case "get":var c=!1;break;case "head":c=!1;break;case "delete":c=!1;break;default:c=!0}!e&&g&&c&&((g=d.fun.obj2xml(g))||(e=1));if(!e){f=d.val.apiUrl+f+".xml";var b={"Cache-Control":"no-store",
"If-None-Match":"empty"};d.val.apiKey&&(b["X-Redmine-API-Key"]=d.val.apiKey);b=d.lib.sjax(a,f,b,g);g=b.responseXML;d.lib.validate(g,"xml")||(e=2)}e||(g=d.fun.xml2obj(b.responseXML))&&(k=g);return k},init:function(){var a,f,g,k=[],e=0,c=0,b=0;b||(c<q.arguments.length?(a=q.arguments(c))?((f="/"!=a.substr(a.length-1))&&(a+="/"),d.val.apiUrl=a):b=2:b=1,c++);b||(c<q.arguments.length?(a=q.arguments(c))?d.val.apiKey=a:b=4:b=3,c++);b||(c<q.arguments.length?(a=q.arguments(c),(g=d.task[a])||(b=6)):b=5,c++);
if(!b)for(f=c,c=q.arguments.length;f<c;f++)a=q.arguments(f),k.push(a);b||(e=g.apply(d,k));q.quit(b?-1*b:e)}})})(readmine,WSH);readmine.init();
